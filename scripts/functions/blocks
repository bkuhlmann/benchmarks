#! /usr/bin/env ruby
# frozen_string_literal: true

require "bundler/inline"

gemfile true do
  source "https://rubygems.org"

  gem "benchmark-ips"
end

Example = Class.new do
  def echo_implicit text
    yield
    text
  end

  def echo_implicit_guard text
    yield if block_given?
    text
  end

  def echo_explicit text, &block
    yield block
    text
  end

  def echo_explicit_guard text, &block
    yield block if block
    text
  end
end

block_example = Example.new
lambda_example = -> text { text }
proc_example = proc { |text| text }

Benchmark.ips do |benchmark|
  benchmark.config time: 5, warmup: 2

  benchmark.report "Block (implicit)" do
    block_example.echo_implicit("hi") { "test" }
  end

  benchmark.report "Block (implicit guard)" do
    block_example.echo_implicit_guard("hi") { "test" }
  end

  benchmark.report "Block (explicit)" do
    block_example.echo_explicit("hi") { "test" }
  end

  benchmark.report "Block (explicit guard)" do
    block_example.echo_explicit_guard("hi") { "test" }
  end

  benchmark.report "Lambda" do
    lambda_example.call "test"
  end

  benchmark.report "Proc" do
    proc_example.call "test"
  end

  benchmark.compare!
end

__END__

ruby 4.0.0 (2025-12-25 revision 553f1675f3) +YJIT +PRISM [arm64-darwin25.2.0]
Warming up --------------------------------------
    Block (implicit)     4.377M i/100ms
Block (implicit guard)
                         4.307M i/100ms
    Block (explicit)   765.699k i/100ms
Block (explicit guard)
                       733.839k i/100ms
              Lambda     2.591M i/100ms
                Proc     2.759M i/100ms
Calculating -------------------------------------
    Block (implicit)     55.054M (± 0.4%) i/s   (18.16 ns/i) -    275.761M in   5.009019s
Block (implicit guard)
                         55.424M (± 0.2%) i/s   (18.04 ns/i) -    279.958M in   5.051249s
    Block (explicit)      8.617M (±10.7%) i/s  (116.05 ns/i) -     42.879M in   5.028149s
Block (explicit guard)
                          8.640M (±11.0%) i/s  (115.74 ns/i) -     43.297M in   5.067570s
              Lambda     34.272M (± 0.2%) i/s   (29.18 ns/i) -    173.607M in   5.065559s
                Proc     34.493M (± 0.2%) i/s   (28.99 ns/i) -    173.797M in   5.038588s

Comparison:
Block (implicit guard): 55423617.9 i/s
    Block (implicit): 55053980.1 i/s - 1.01x  slower
                Proc: 34493418.9 i/s - 1.61x  slower
              Lambda: 34272211.4 i/s - 1.62x  slower
Block (explicit guard):  8640102.7 i/s - 6.41x  slower
    Block (explicit):  8616900.9 i/s - 6.43x  slower
