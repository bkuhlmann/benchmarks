#! /usr/bin/env ruby
# frozen_string_literal: true

require "bundler/inline"

gemfile true do
  source "https://rubygems.org"

  gem "benchmark-ips"
end

ProcFunction = proc { |message = "message"| message }
LambdaFunction = -> message = "benchmark" { message }

module ModuleFunction
  module_function

  def call(message = "benchmark") = message
end

class ClassFunction
  def initialize message = "benchmark"
    @message = message
  end

  def call = message

  private

  attr_reader :message
end

memoized_function = ClassFunction.new

Benchmark.ips do |benchmark|
  benchmark.config time: 5, warmup: 2

  benchmark.report("Proc") { ProcFunction.call }
  benchmark.report("Lambda") { LambdaFunction.call }
  benchmark.report("Module") { ModuleFunction.call }
  benchmark.report("Class (new)") { ClassFunction.new.call }
  benchmark.report("Class (memoized)") { memoized_function.call }

  benchmark.compare!
end

__END__

ruby 3.4.7 (2025-10-08 revision 7a5688e2a2) +YJIT +PRISM [arm64-darwin24.6.0]
Warming up --------------------------------------
                Proc     2.286M i/100ms
              Lambda     2.350M i/100ms
              Module     4.052M i/100ms
         Class (new)     1.439M i/100ms
    Class (memoized)     4.108M i/100ms
Calculating -------------------------------------
                Proc     25.581M (± 0.3%) i/s   (39.09 ns/i) -    128.037M in   5.005105s
              Lambda     25.148M (± 0.7%) i/s   (39.77 ns/i) -    126.888M in   5.045937s
              Module     60.385M (± 2.1%) i/s   (16.56 ns/i) -    303.872M in   5.034485s
         Class (new)     15.939M (± 0.9%) i/s   (62.74 ns/i) -     80.600M in   5.057388s
    Class (memoized)     58.861M (± 1.0%) i/s   (16.99 ns/i) -    295.759M in   5.025159s

Comparison:
              Module: 60384824.1 i/s
    Class (memoized): 58861253.9 i/s - same-ish: difference falls within error
                Proc: 25581483.1 i/s - 2.36x  slower
              Lambda: 25147676.1 i/s - 2.40x  slower
         Class (new): 15938516.3 i/s - 3.79x  slower
