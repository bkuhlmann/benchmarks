#! /usr/bin/env ruby
# frozen_string_literal: true

require "bundler/inline"

gemfile true do
  source "https://rubygems.org"

  gem "benchmark-ips"
end

Example = Class.new do
  def echo_implicit text
    yield
    text
  end

  def echo_implicit_guard text
    yield if block_given?
    text
  end

  def echo_explicit text, &block
    yield block
    text
  end

  def echo_explicit_guard text, &block
    yield block if block
    text
  end
end

block_example = Example.new
lambda_example = -> text { text }
proc_example = proc { |text| text }

Benchmark.ips do |benchmark|
  benchmark.config time: 5, warmup: 2

  benchmark.report "Block (implicit)" do
    block_example.echo_implicit("hi") { "test" }
  end

  benchmark.report "Block (implicit guard)" do
    block_example.echo_implicit_guard("hi") { "test" }
  end

  benchmark.report "Block (explicit)" do
    block_example.echo_explicit("hi") { "test" }
  end

  benchmark.report "Block (explicit guard)" do
    block_example.echo_explicit_guard("hi") { "test" }
  end

  benchmark.report "Lambda" do
    lambda_example.call "test"
  end

  benchmark.report "Proc" do
    proc_example.call "test"
  end

  benchmark.compare!
end

__END__

ruby 3.3.0 (2023-12-25 revision 5124f9ac75) +YJIT [arm64-darwin22.6.0]
Warming up --------------------------------------
    Block (implicit)     2.399M i/100ms
Block (implicit guard)
                         2.308M i/100ms
    Block (explicit)   450.130k i/100ms
Block (explicit guard)
                       449.734k i/100ms
              Lambda     1.669M i/100ms
                Proc     1.645M i/100ms
Calculating -------------------------------------
    Block (implicit)     46.862M (± 0.1%) i/s -    235.143M in   5.017800s
Block (implicit guard)
                         45.439M (± 0.1%) i/s -    228.508M in   5.028862s
    Block (explicit)      5.056M (± 5.3%) i/s -     25.657M in   5.087058s
Block (explicit guard)
                          5.045M (± 5.4%) i/s -     25.185M in   5.004320s
              Lambda     27.275M (± 0.1%) i/s -    136.832M in   5.016843s
                Proc     27.075M (± 0.1%) i/s -    136.520M in   5.042320s

Comparison:
    Block (implicit): 46861784.2 i/s
Block (implicit guard): 45439260.8 i/s - 1.03x  slower
              Lambda: 27274557.0 i/s - 1.72x  slower
                Proc: 27074831.5 i/s - 1.73x  slower
    Block (explicit):  5056252.9 i/s - 9.27x  slower
Block (explicit guard):  5045448.0 i/s - 9.29x  slower
