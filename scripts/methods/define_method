#! /usr/bin/env ruby
# frozen_string_literal: true

require "bundler/inline"

gemfile true do
  source "https://rubygems.org"

  gem "benchmark-ips"
end

require "forwardable"

Person = Class.new do
  def initialize first, last
    @first = first
    @last = last
  end

  def full_name
    "#{first} #{last}"
  end

  private

  attr_reader :first, :last
end

Example = Class.new Person do
  extend Forwardable

  define_method :unbound_full_name, Person.instance_method(:full_name)
  delegate %i[full_name] => :person

  def initialize first, last, person: Person.new(first, last)
    super first, last
    @person = person
  end

  def wrapped_full_name
    person.full_name
  end

  private

  attr_reader :first, :last, :person
end

example = Example.new "Jill", "Doe"

Benchmark.ips do |benchmark|
  benchmark.config time: 5, warmup: 2

  benchmark.report("Wrapped") { example.wrapped_full_name }
  benchmark.report("Defined") { example.unbound_full_name }
  benchmark.report("Delegated") { example.full_name }

  benchmark.compare!
end

__END__

ruby 4.0.0 (2025-12-25 revision 553f1675f3) +YJIT +PRISM [arm64-darwin25.2.0]
Warming up --------------------------------------
             Wrapped     1.513M i/100ms
             Defined     1.452M i/100ms
           Delegated     1.057M i/100ms
Calculating -------------------------------------
             Wrapped     16.392M (± 2.2%) i/s   (61.00 ns/i) -     83.190M in   5.077430s
             Defined     16.887M (± 3.4%) i/s   (59.22 ns/i) -     85.679M in   5.079576s
           Delegated     11.425M (± 2.3%) i/s   (87.53 ns/i) -     58.122M in   5.090109s

Comparison:
             Defined: 16887107.4 i/s
             Wrapped: 16392341.2 i/s - same-ish: difference falls within error
           Delegated: 11425005.5 i/s - 1.48x  slower
